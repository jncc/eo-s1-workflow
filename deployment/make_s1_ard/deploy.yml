---
- name: Install make_s1_backscatter_ard shell script to /usr/local/bin
  template:
    src: ./deployment/make_s1_ard/cron/make_s1_ard
    dest: /usr/local/bin/make_s1_backscatter_ard
    mode: "a+x"
  
- name: Create make_s1_backscatter_ard cron file in cron.d folder (set to run every hour, unless already running by [PID File])
  cron:
    name: make_s1_backscatter_ard
    minute: 30
    user: ubuntu
    job: "/usr/local/bin/make_s1_backscatter_ard"
    cron_file: make_s1_backscatter_ard
    state: present
  when: (current_env == "show") or (force_cron is defined and force_cron == true)

- name: Disable make_s1_backscatter_ard cron task in non show and tell environments (set to run every hour, unless already running by [PID File])
  cron:
    name: make_s1_backscatter_ard
    minute: 30
    user: ubuntu
    job: "/usr/local/bin/make_s1_backscatter_ard"
    cron_file: make_s1_backscatter_ard
    state: present
    disabled: true
  when: (current_env != "show") or (force_cron is not defined or force_cron == false)

# S1 ARD Processing
# - name: Ensure local folder for ARD processing exists
#   file:
#     path: /data/sentinel/1/raw/
#     state: directory
#     owner: ubuntu

# Space at front of value to prevent it being recognised as a python variable and the quotes stripped to single quotes
- name: Modify pathroots in cfg file for S1 ARD Processing Tasks
  ini_file:
    path: /luigi/workflows/luigi.cfg
    section: ProcessRawS1Files
    option: pathroots
    value: " {\"state-s3Root\": \"s3://{{ bucket-prefix }}-{{ current_env }}/workflows/sentinel/1/processed/ard/backscatter\",\"product-s3Root\": \"s3://{{ bucket-prefix }}-{{ current_env }}/sentinel/1/processed/ard/backscatter\",\"localPathRoot\": \"/data/sentinel/1/\"}"

- name: Modify S3 Bucket in cfg file for S1 ARD Processing Tasks
  ini_file:
    path: /luigi/workflows/luigi.cfg
    section: ProcessRawS1Files
    option: s3Bucket
    value: "\"{{ bucket-prefix }}-{{ current_env }}\""