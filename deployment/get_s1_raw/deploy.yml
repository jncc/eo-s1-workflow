---
- name: Install get_s1_raw shell script to /usr/local/bin
  template:
    src: ./deployment/get_s1_raw/cron/get_s1_raw
    dest: /usr/local/bin/get_s1_raw
    mode: "a+x"
  
- name: Create get_s1_raw cron file in cron.d folder
  cron:
    name: get_s1_raw
    minute: 0
    user: root
    job: "/usr/local/bin/get_s1_raw"
    cron_file: gets1raw
    state: present
  when: (current_env == "show") or (force_cron is defined and force_cron == true)

- name: Disable get_s1_raw cron task in non show and tell environments
  cron:
    name: get_s1_raw
    minute: 0
    user: root
    job: "/usr/local/bin/get_s1_raw"
    cron_file: gets1raw
    state: present
    disabled: true
  when: (current_env != "show") or (force_cron is not defined or force_cron == false)

- name: Clear temp directory for s1-downloader
  file:
    path: /luigi/temp/workflows/sentinel/1/downloader
    state: absent

- name: Ensure temp directory for s1-download exists
  file:
    path: /luigi/temp/workflows/sentinel/1/downloader
    state: directory
    owner: ubuntu
    recurse: yes

# Space at front of value to prevent it being recognised as a python variable and the quotes stripped to single quotes
- name: Modify pathroots in cfg file for S1 Tasks
  ini_file:
    path: /luigi/workflows/luigi.cfg
    section: GetS1RawProducts
    option: pathroots
    value: " {\"state-localRoot\": \"/luigi/temp/workflows/sentinel/1/downloader\", \"state-s3Root\": \"s3://{{ bucket-prefix }}-{{ current_env }}/workflows/sentinel/1/downloader\",\"product-s3Root\": \"s3://{{ bucket-prefix }}-{{ current_env }}/sentinel/1/raw\"}"

- name: Modify ceda user in cfg file for S1 Tasks
  ini_file:
    path: /luigi/workflows/luigi.cfg
    section: GetS1RawProducts
    option: cedaFtpUser
    value: "{{ ceda_ftp_user }}"

- name: Modify ceda password in cfg file for S1 Tasks
  ini_file:
    path: /luigi/workflows/luigi.cfg
    section: GetS1RawProducts
    option: cedaFtpPassword
    value: "{{ ceda_ftp_password }}"

- name: Ensure seed folder for S1 Downloader exists
  file:
    path: /luigi/temp/workflows/sentinel/1/downloader/2017-11-04
    state: directory
    owner: ubuntu

- name: Create seed file - AvailableProducts
  copy:
    src: /luigi/workflows/get_s1_raw/seed/AvailableProducts.json
    dest: /luigi/temp/workflows/sentinel/1/downloader/2017-11-04/AvailableProducts.json
    remote_src: yes
    owner: ubuntu
  
- name: Create seed file - S1RawProducts
  copy:
    src: /luigi/workflows/get_s1_raw/seed/S1RawProducts.json
    dest: /luigi/temp/workflows/sentinel/1/downloader/2017-11-04/S1RawProducts.json
    remote_src: yes
    owner: ubuntu